<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Music Score Practice System — Evaluation Questionnaire (1:1 Interview)</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#171923;--ink:#e6e8ef;--muted:#aab0c0;--brand:#714800;--ok:#2ecc71;--warn:#f39c12
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .app{display:grid;grid-template-columns:1.2fr 1fr;gap:16px;height:100vh;padding:16px;box-sizing:border-box}
    @media (max-width: 1000px){.app{grid-template-columns:1fr;grid-auto-rows:min-content}}
    .left,.right{background:var(--panel);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.3);overflow:hidden;position:relative}
    .left{display:flex;flex-direction:column}
    .videoWrap{position:relative;aspect-ratio:16/9;background:#0b0d12;display:grid;place-items:center}
    video{width:100%;height:100%;object-fit:contain;background:#000}
    .caption{padding:12px 16px;color:var(--muted);border-top:1px solid rgba(255,255,255,.05)}
    .right{display:flex;flex-direction:column}
    .head{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.05)}
    .title{font-weight:700}
    .progress{height:6px;background:#222532;border-radius:999px;margin:0 16px 10px;overflow:hidden}
    .bar{height:100%;background:var(--brand);width:0}
    .content{padding:12px 16px 8px;overflow:auto}
    .q{margin:12px 0;padding:12px 12px 8px;border:1px solid rgba(255,255,255,.06);border-radius:10px}
    .q h4{margin:0 0 8px;font-size:16px}
    .likert{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:8px}
    .likert label{display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px;border-radius:8px;background:#1b1e29;cursor:pointer;border:1px solid transparent}
    .likert input{accent-color:var(--brand)}
    .hint{color:var(--muted);font-size:12px}
    .opts{display:grid;gap:8px;margin-top:6px}
    .opts label{display:flex;align-items:center;gap:10px;background:#1b1e29;padding:8px;border-radius:8px}
    textarea, input[type="text"]{width:100%;box-sizing:border-box;background:#121420;border:1px solid #2a2f40;color:var(--ink);border-radius:10px;padding:10px}
    .footer{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid rgba(255,255,255,.05)}
    button{background:#222532;color:var(--ink);border:1px solid rgba(255,255,255,.08);padding:10px 14px;border-radius:10px;cursor:pointer}
    .primary{background:var(--brand);border-color:transparent}
    .ghost{background:transparent}
    .pill{display:inline-block;padding:2px 8px;border:1px solid rgba(255,255,255,.12);border-radius:999px;color:var(--muted);font-size:12px}
    .meta{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}
    .notice{padding:10px 12px;background:#131624;border-left:4px solid var(--brand);border-radius:8px;color:#d9dbe6}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){.grid2{grid-template-columns:1fr}}
    .videoWrap {
      display: flex; justify-content: center; align-items: center; height: 100%; overflow: hidden;
    }
    .videoWrap video, .videoWrap img{
      width: 720px; height: auto; max-height: 100%; object-fit: contain; display:block;
    }
    .videoWrap img{ background:#FCF7F4 !important; border-radius:0; }
  </style>
</head>
<body>
<div class="app">
  <!-- Left: media area -->
  <section class="left">
    <div class="videoWrap"></div>
    <div class="caption">
      <div class="meta">
        <span class="pill" id="pageTag">Overview</span>
        <span id="vidCaption">Please watch the introduction video first, then answer the questions on the right.</span>
      </div>
    </div>
  </section>

  <!-- Right: questionnaire area -->
  <section class="right">
    <div class="head">
      <div class="title" id="title">Music Score Practice System — Evaluation Questionnaire (Interview)</div>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <div class="content" id="content"></div>
    <div class="footer">
      <button class="ghost" id="btnBack">Back</button>
      <button class="primary" id="btnNext">Next</button>
    </div>
  </section>
</div>

<script>
// ======== Pages & Questions ========
const PAGES = [
  // Consent
  {
    id: 'consent', type: 'intro',
    title: 'Before We Start', tag: 'Consent',
    caption: 'Thank you for taking part in this study, in which we want to gather feedback on a research system prototype. This study is part of a contribution in a research article.<br><br>We will be recording your written and spoken responses to help inform our analysis. You can stop this study at any moment and ask for your data to be deleted. Otherwise, we will delete data upon publication of article.',
    blocks: [
      { kind:'html', html:`<div class="notice">Flow: Overview → Feature-by-feature demos → Visualization comprehension. All questions on the right are required (except open-ended).</div>`},
      { kind:'checkbox', id:'consent', label:'I have read the study information and agree to participate in this research.', options:[{value:'yes',label:'Agree'}], required:true },
      { kind:'text', id:'pid', label:'Participant ID (filled by the researcher; may be left blank)', placeholder:'e.g., P07', required:true }
    ]
  },

  // Pre gate & background (kept)
  {
    id: 'pre_gate',
    type: 'questions',
    tag: 'Pre-Check',
    title: 'Before the overview',
    caption: 'Have you previously taken part in an interview for this study?',
    questions: [
      { id: 'done_interview_before', label: 'Have you done an interview before for this study?', type: 'yesno', required: true }
    ]
  },

  {
    id: 'pre_background',
    type: 'questions',
    tag: 'Background',
    title: 'Your background with music practice',
    caption: 'Please answer a few questions about your musical background.',
    questions: [
      { id: 'main_instrument', label: 'What main instrument do you play?', type: 'text', required: true },
      { id: 'learning_duration', label: 'How long have you been learning this instrument?', type: 'text', required: true },

      { id: 'learned_mode', label: 'Did you learn by yourself, or do you/did you have a teacher?', type: 'opts', required: true,
        options: [
          { v:'self',    t:'I learned by myself' },
          { v:'teacher', t:'I have/had a teacher' },
          { v:'both',    t:'Both' }
        ]
      },

      { id: 'ensemble_mode', label: 'Do you play alone, or do you also play with other musicians?', type: 'opts', required: true,
        options: [
          { v:'alone',  t:'I usually play alone' },
          { v:'others', t:'I also play with other musicians' },
          { v:'both',   t:'Both' }
        ]
      },

      { id: 'ensemble_marking_diff',
        label: 'If other musicians: Have you noticed any differences in how you mark your sheet music when playing solo, in a duet, or in an orchestra?',
        type: 'textarea', placeholder: 'Describe any differences you’ve noticed…', required: true,
        dependsOn: 'ensemble_mode', oneOf: ['others','both']
      },

      { id: 'marking_routine',
        label: 'Do you have your own “marking routine”? (e.g., annotate after each page, or whenever something comes to mind)',
        type: 'textarea', placeholder: 'Describe your routine if any…', required: true
      },

      { id: 'practice_medium', label: 'Do you usually use printed scores or a tablet to practice?', type: 'group', items: [
        { id: 'practice_medium_choice', label: 'Choose one', type: 'opts', required: true,
          options: [
            { v:'printed', t:'Printed scores' },
            { v:'tablet',  t:'Tablet' },
            { v:'both',    t:'Both' }
          ]
        },
        { id: 'practice_why', label: 'Why?', type: 'textarea', placeholder: 'Your reasons…', required: true }
      ]},

      { id: 'tablet_software_block', label: 'If you use a tablet:', type: 'group',
        dependsOn: 'practice_medium_choice', oneOf: ['tablet','both'],
        items: [
          { id: 'tablet_software', label: 'What software do you use?', type: 'text', required: true },
          { id: 'tablet_duration', label: 'For how long have you used it?', type: 'text', required: true },
          { id: 'tablet_features_helpful', label: 'What are some helpful features you’ve experienced with it?', type: 'textarea', placeholder: 'List helpful features…', required: true },
          { id: 'tablet_features_inconveniences', label: 'What inconveniences have you experienced with it?', type: 'textarea', placeholder: 'List inconveniences…', required: true }
        ]
      }
    ]
  },

// Overview 
{
  id:'overview', type:'intro', tag:'Overview',
  title:'Overview: System Goals & Five Features',
  video:'1.mp4',
  caption:'overview of the system and its five main features',
  blocks: [
    {
      kind:'html',
      html: `
        <div class="notice" style="margin-bottom:12px;">
          Our idea is to design a system that helps musicians practice reading scores.
        </div>
        <div style="line-height:1.6;">
          <p><strong>We focused on five features</strong> that can support musicians in their practice:</p>
          <ul>
            <li>Reveal All Accidentals</li>
            <li>Add Symbols</li>
            <li>Pitch Practice Mode</li>
            <li>Rhythm Practice Mode</li>
            <li>Performance Practice Mode</li>
          </ul>
        </div>
      `
    }
  ]
},
  // Feature 1 — Accidentals
  {
    id:'feature1_accidentals', type:'video+qs', tag:'Feature',
    title:'Feature 1 — Reveal All Accidentals',
    video:'1.1.mp4',
    caption:'Display all accidentals according to the key signature; users can also choose which accidentals to show.',
    questions:[
      { id:'f1_useful', label:'Please rate the usefulness of this feature (1 = Not useful at all, 7 = Very useful).', type:'likert7', required:true },
      { id:'f1_g_clef', label:'Please evaluate the gesture that triggers the display of accidentals (clef).', type:'group', items:[
        { id:'f1_g_clef_perf', label:'Do you find this easy to perform?', type:'likert7', required:true },
        { id:'f1_g_clef_mem',  label:'Do you find this easy to remember?', type:'likert7', required:true }
      ]}
    ]
  },

  // Feature 2 — Add Symbols
  {
    id:'feature2_symbols', type:'video+qs', tag:'Feature',
    title:'Feature 2 — Add Symbols',
    video:'1.2.mp4',
    caption:'Add accidentals or custom symbols to the score.',
    questions:[
      { id:'f2_useful', label:'Please rate the usefulness of this feature (1 = Not useful at all, 7 = Very useful).', type:'likert7', required:true },
      { id:'f2_g_sharp', label:'Please evaluate the gesture that triggers annotation (sharp).', type:'group', items:[
        { id:'f2_g_sharp_perf', label:'Do you find this easy to perform?', type:'likert7', required:true },
        { id:'f2_g_sharp_mem',  label:'Do you find this easy to remember?', type:'likert7', required:true }
      ]}
    ]
  },

  // Feature 3 — Pitch Practice
  {
    id:'feature3_pitch', type:'video+qs', tag:'Feature',
    title:'Feature 3 — Pitch Practice Mode',
    video:'1.3.mp4',
    caption:'Sing the melody and record; the system provides feedback on pitch errors.',
    questions:[
      { id:'f3_useful', label:'Please rate the usefulness of this feature (1 = Not useful at all, 7 = Very useful).', type:'likert7', required:true },
      { id:'f3_g_circle', label:'Please evaluate the gesture that triggers pitch practice (circle).', type:'group', items:[
        { id:'f3_g_circle_perf', label:'Do you find this easy to perform?', type:'likert7', required:true },
        { id:'f3_g_circle_mem',  label:'Do you find this easy to remember?', type:'likert7', required:true }
      ]},
      { id:'f3_train_focus', label:'Do you feel that selecting a specific segment to hide the rest of the score would help you focus during practice?', type:'likert7', required:true }
    ]
  },

  // Feature 4 — Rhythm Practice
  {
    id:'feature4_rhythm', type:'video+qs', tag:'Feature',
    title:'Feature 4 — Rhythm Practice Mode',
    video:'1.4.mp4',
    caption:'Tap along with the metronome and the score; the system detects and shows rhythm errors.',
    questions:[
      { id:'f4_useful', label:'Please rate the usefulness of this feature (1 = Not useful at all, 7 = Very useful).', type:'likert7', required:true },
      { id:'f4_g_vlines', label:'Please evaluate the gesture that triggers rhythm practice (two vertical lines).', type:'group', items:[
        { id:'f4_g_vlines_perf', label:'Do you find this easy to perform?', type:'likert7', required:true },
        { id:'f4_g_vlines_mem',  label:'Do you find this easy to remember?', type:'likert7', required:true }
      ]}
    ]
  },

  // Feature 5 — Performance Practice
  {
    id:'feature5_performance', type:'video+qs', tag:'Feature',
    title:'Feature 5 — Performance Practice Mode',
    video:'1.5.mp4',
    caption:'Record your instrument performance; the system gives feedback on both pitch and rhythm together.',
    questions:[
      { id:'f5_useful', label:'Please rate the usefulness of this feature (1 = Not useful at all, 7 = Very useful).', type:'likert7', required:true },
      { id:'f5_g_play', label:'Please evaluate the gesture that triggers performance mode (circle + two vertical lines).', type:'group', items:[
        { id:'f5_g_play_perf', label:'Do you find this easy to perform?', type:'likert7', required:true },
        { id:'f5_g_play_mem',  label:'Do you find this easy to remember?', type:'likert7', required:true }
      ]},
      { id:'f3_g_perf_circle', label:'Please evaluate the gesture that expands detailed pitch visualization in performance mode (circle again).', type:'group', items:[
        { id:'f3_g_perf_circle_perf', label:'Do you find this easy to perform?', type:'likert7', required:true },
        { id:'f3_g_perf_circle_mem',  label:'Do you find this easy to remember?', type:'likert7', required:true }
      ]},
      { id:'f4_g_perf_vlines', label:'Please evaluate the gesture that expands detailed rhythm visualization in performance mode (two vertical lines again).', type:'group', items:[
        { id:'f4_g_perf_vlines_perf', label:'Do you find this easy to perform?', type:'likert7', required:true },
        { id:'f4_g_perf_vlines_mem',  label:'Do you find this easy to remember?', type:'likert7', required:true }
      ]}
    ]
  },

  /* ===== Visualization pages (unchanged IDs from your latest unique set) ===== */

  // C1. Pitch visualization
  {
    id:'viz_pitch_r', type:'video+qs', tag:'Viz-Pitch',
    title:'II. Visualization: Pitch Errors(rough)',
    video:'2.1.mp4',
    caption:'Shows two types of pitch errors (too high / too low) as well as colors and symbols.',
    questions:[

      // 1) Do the marks clearly indicate pitch?
      { id:'vp_marks_meaning_clear',
        label:'Do these marks(colored note heads + small note symbols and line above) clearly indicate “pitch errors”?',
        type:'likert7', required:true
      },

      // 2) Counting task
      { id:'vp_count_errors',
        label:'How many pitch errors can you count in this excerpt?',
        type:'text', required:true
      },

      // 3) Error A
      { id:'vp_A_block',
        label:'Error A',
        type:'group',
        items:[
          { id:'vp_A_direction',
            label:'Is error A “too high” or “too low”?',
            type:'opts', required:true,
            options:[
              { v:'too_high', t:'Too high' },
              { v:'too_low',  t:'Too low' }
            ]
          },
          { id:'vp_A_magnitude',
            label:'What is the approximate magnitude of error A? (e.g., 20 cents / a semitone / more than a fourth / “Not sure”)',
            type:'text', required:true
          }
        ]
      },

      // 4) Error B
      { id:'vp_B_block',
        label:'Error B',
        type:'group',
        items:[
          { id:'vp_B_direction',
            label:'Is error B “too high” or “too low”?',
            type:'opts', required:true,
            options:[
              { v:'too_high', t:'Too high' },
              { v:'too_low',  t:'Too low' }
            ]
          },
          { id:'vp_B_magnitude',
            label:'What is the approximate magnitude of error B?',
            type:'text', required:true
          }
        ]
      },

      // 5) Readability
      { id:'vp_readable_new',
        label:'Overall, is this pitch error visualization easy to read?',
        type:'likert7', required:true
      },

      // 6) Open comments
      { id:'vp_open_new',
        label:'Additional comments (Pitch visualization):',
        type:'textarea', placeholder:'Any pros/cons or suggestions', required:false
      }
    ]
  },
  {
    id:'viz_sp', type:'video+qs', tag:'Viz-Combined',
    title:'II. Visualization: Pitch Errors (detailed)',
    video:'sp.mp4',
    caption:'Shows specific pitch errors with colors and symbols as well as animation.',
    questions:[
      // Error A
      {
        id:'sp_A_block',
        label:'Error A',
        type:'group',
        items:[
          {
            id:'sp_A_direction',
            label:'Is error A “too high” or “too low”?',
            type:'opts', required:true,
            options:[
              { v:'too_high', t:'Too high' },
              { v:'too_low',  t:'Too low' }
            ]
          },
          {
            id:'sp_A_magnitude',
            label:'What is the precise magnitude of error A? (e.g., 20 cents / a semitone / augmented fourth / “Not sure”)',
            type:'text', required:true
          }
        ]
      },

      // Error B
      {
        id:'sp_B_block',
        label:'Error B',
        type:'group',
        items:[
          {
            id:'sp_B_direction',
            label:'Is error B “too high” or “too low”?',
            type:'opts', required:true,
            options:[
              { v:'too_high', t:'Too high' },
              { v:'too_low',  t:'Too low' }
            ]
          },
          {
            id:'sp_B_magnitude',
            label:'What is the precise magnitude of error B?',
            type:'text', required:true
          }
        ]
      },
      {
        id:'sp_gray_readable',
        label:'Is the image inside the yellow rectangle (detailed pitch visualization) readable?',
        type:'likert7', required:true
      },
      {
        id:'sp_anim_notehead',
        label:'Is the “note-head movement” animation readable?',
        type:'likert7', required:true
      },

      {
        id:'sp_anim_fine',
        label:'Is the “fine pitch deviation graphic” (after clicking the gauge icon) readable?',
        type:'likert7', required:true
      },
            // 6) Open comments
      { id:'vp_open_new1',
        label:'Additional comments (Pitch visualization):',
        type:'textarea', placeholder:'Any pros/cons or suggestions', required:false
      }
    ]
  },

// C2. Rhythm visualization
  {
    id:'viz_rhythm1', type:'video+qs', tag:'Viz-Rhythm',
    title:'II. Visualization: Rhythm Errors(rough)',
    video:'3.1.mp4',
    caption:'Shows two types of rhythm errors (too fast / too slow) as well as colors and symbols.',
    questions:[
      { id:'vr1_marks_meaning_clear',
        label:'Do these marks(colored note heads + small note symbols and line above) clearly indicate “rhythm errors”?',
        type:'likert7', required:true
      },
      { id:'vr1_count_errors',
        label:'How many rhythm errors can you count in this excerpt? (Enter a number)',
        type:'text', required:true
      },
      { id:'vr1_A_block',
        label:'Error A',
        type:'group',
        items:[
          { id:'vr1_A_direction',
            label:'Is error A “too fast” (ahead) or “too slow” (behind)?',
            type:'opts', required:true,
            options:[
              { v:'too_fast', t:'Too fast (ahead of the beat)' },
              { v:'too_slow', t:'Too slow (behind the beat)' }
            ]
          },
          { id:'vr1_A_magnitude',
            label:'What is the approximate amount of deviation for A (in beats)? (e.g., 0.25 beat / ⅛ beat / “Not sure”)',
            type:'text', required:true
          }
        ]
      },
      { id:'vr1_B_block',
        label:'Error B',
        type:'group',
        items:[
          { id:'vr1_B_direction',
            label:'Is error B “too fast” (ahead) or “too slow” (behind)?',
            type:'opts', required:true,
            options:[
              { v:'too_fast', t:'Too fast (ahead of the beat)' },
              { v:'too_slow', t:'Too slow (behind the beat)' }
            ]
          },
          { id:'vr1_B_magnitude',
            label:'What is the approximate amount of deviation for B (in beats)?',
            type:'text', required:true
          }
        ]
      },
      { id:'vr1_readable',
        label:'Overall, is this rhythm error visualization easy to read?',
        type:'likert7', required:true
      },
      { id:'vr1_open',
        label:'Additional comments (Rhythm visualization — Version 1):',
        type:'textarea', placeholder:'Any pros/cons or suggestions', required:false
      }
    ]
  },
{
  id:'viz_combo_r', type:'video+qs', tag:'Viz-Rhythm',
  title:'II. Visualization: Rhythm Errors (detailed)',
  video:'sr.mp4',
  caption:'Vertical lines/slanted guides show detailed rhythm. Click to reveal the line-rotation + horizontal note-head movement animation.',
  questions:[

    // Error A 
    {
      id:'sr_A_block',
      label:'Error A',
      type:'group',
      items:[
        {
          id:'sr_A_direction',
          label:'Is error A “too fast” (ahead) or “too slow” (behind)?',
          type:'opts', required:true,
          options:[
            { v:'too_fast', t:'Too fast (ahead of the beat)' },
            { v:'too_slow', t:'Too slow (behind the beat)' }
          ]
        },
        {
          id:'sr_A_magnitude',
          label:'What is the specific amount of deviation for A (in beats)? (e.g., 0.25 beat / ⅛ beat / “Not sure”)',
          type:'text', required:true
        }
      ]
    },
        // Error B 
    {
      id:'sr_B_block',
      label:'Error B',
      type:'group',
      items:[
        {
          id:'sr_B_direction',
          label:'Is error B “too fast” (ahead) or “too slow” (behind)?',
          type:'opts', required:true,
          options:[
            { v:'too_fast', t:'Too fast (ahead of the beat)' },
            { v:'too_slow', t:'Too slow (behind the beat)' }
          ]
        },
        {
          id:'sr_B_magnitude',
          label:'What is the specific amount of deviation for A (in beats)?',
          type:'text', required:true
        }
      ]
    },

    // Readability of line 
    {
      id:'sr_detail_readable',
      label:'Is the detailed rhythm visualization (inside the yellow rectangle) readable?',
      type:'likert7', required:true
    },

    // Readability of the rhythm animation
    {
      id:'sr_anim_readable',
      label:'Is the rhythm animation (line rotation + horizontal note-head movement) readable?',
      type:'likert7', required:true
    },
            // 6) Open comments
      { id:'vr_open_new1',
        label:'Additional comments (Pitch visualization):',
        type:'textarea', placeholder:'Any pros/cons or suggestions', required:false
      }
  ]
},
  {
    id:'viz_rhythm2', type:'intro', tag:'Viz-Rhythm',
    title:'II. Visualization: Different Rhythm Error Encodings',
    video:'3.2.png',
    caption:'Focused illustration: the same rhythm error rendered by two encodings.',
    blocks:[
      {
        kind:'html',
        html: `
          <div class="notice" style="margin-bottom:12px;">
            On the left, we can see the <strong>same rhythm error</strong> rendered by both encodings
          </div>
          <div style="line-height:1.6;">
            <p><strong>Why two visualizations?</strong></p>
            <ul>
              <li><strong>Constant length:</strong> one beat is always represented with a constant visual length, independent of notation context.</li>
              <li><strong>Notation-dependent length:</strong> the visual length of one beat depends on the local notational context (e.g., tuplets, beaming, accidentals), so spacing adapts to the score structure.</li>
            </ul>
          </div>
        `
      }
    ]
  },
  {
    id:'viz_rhythm3', type:'video+qs', tag:'Viz-Rhythm',
    title:'II. Visualization: Comparing Rhythm Error Visualizations',
    video:['1.png','2.png'],
    caption:'Compare the two rhythm error visualizations side by side.',
    questions:[
      {
        id:'vr_cmp_prefer',
        label:'Between these two rhythm visualizations, which one do you prefer?',
        type:'opts', required:true,
        options:[
          { v:'constant',           t:'Constant length' },
          { v:'notation_dependent', t:'Notation-dependent length' }
        ]
      },
      {
        id:'vr_cmp_amount',
        label:'Which visualization makes it easier to assess the amount of deviation?',
        type:'opts', required:true,
        options:[
          { v:'constant',           t:'Constant length' },
          { v:'notation_dependent', t:'Notation-dependent length' }
        ]
      },
      {
        id:'vr_cmp_compare',
        label:'Which visualization makes it easier to compare two different errors?',
        type:'opts', required:true,
        options:[
          { v:'constant',           t:'Constant length' },
          { v:'notation_dependent', t:'Notation-dependent length' }
        ]
      }
    ]
  },

  // C3. Combined visualization (performance mode)
  {
    id:'viz_combo_rough', type:'video+qs', tag:'Viz-Combined',
    title:'II. Visualization: Combined (Pitch + Rhythm)(rough)',
    video:'4.1.mp4',
    caption:'This page shows pitch and rhythm error visualizations together.',
    questions:[
      // Pitch for A
      { id:'vcr_A_pitch_block', label:'Error A — Pitch', type:'group',
        items:[
          { id:'vcr_A_pitch_direction',
            label:'Is error A “too high” or “too low”?',
            type:'opts', required:true,
            options:[
              { v:'too_high', t:'Too high' },
              { v:'too_low',  t:'Too low' }
            ]
          },
          { id:'vcr_A_pitch_magnitude',
            label:'What is the approximate magnitude of error A?',
            type:'text', required:true
          }
        ]
      },

    // Rhythm for A
      { id:'vcr_A_rhythm_block', label:'Error A — Rhythm', type:'group',
        items:[
          { id:'vcr_A_rhy_direction',
            label:'Is error A “too fast” (ahead) or “too slow” (behind)?',
            type:'opts', required:true,
            options:[
              { v:'too_fast', t:'Too fast (ahead of the beat)' },
              { v:'too_slow', t:'Too slow (behind the beat)' }
            ]
          },
          { id:'vcr_A_rhy_magnitude',
            label:'What is the approximate amount of deviation for A (in beats)?',
            type:'text', required:true
          }
        ]
      },

      // Overall readability
      { id:'vcr_readable',
        label:'Overall, is this combined error visualization easy to read?',
        type:'likert7', required:true
      },
            // 6) Open comments
      { id:'vc_open_new1',
        label:'Additional comments:',
        type:'textarea', placeholder:'Any pros/cons or suggestions', required:false
      }
    ]
  },
    // C3. Combined visualization (performance mode)
  {
    id:'viz_combo_detailed', type:'video+qs', tag:'Viz-Combined',
    title:'II. Visualization: Combined (Pitch + Rhythm)(detailed)',
    video:'4combine2.mp4',
    caption:'This page shows pitch and rhythm error visualizations together in detail.',
    questions:[
      { id:'vcc_useful',
        label:'Do you understand what the top horizontal line represents in the combined view?',
        type:'likert7', required:true
      },
      // Overall readability
      { id:'vcc_readable',
        label:'Is the horizontal line above the rectangle easy to read?',
        type:'likert7', required:true
      }
    ]
  },

  // Overall system questions (moved here, just before finish)
  {
    id:'overall_system', type:'questions', tag:'Overall',
    title:'Overall Evaluation',
    caption:'To conclude, please rate the overall usefulness and your intention to use.',
    questions:[
      { id:'overall_useful_system', label:'Do you think this system would be useful for you?', type:'likert7', required:true },
      { id:'overall_intend_use',    label:'Would you be willing to use it in your daily practice?', type:'likert7', required:true }
    ]
  },

  // Finish
  {
    id:'finish', type:'finish', tag:'Finish', title:'Finish & Export',
    blocks:[
      { kind:'html', html:`<p>Thank you for your participation! Click “Export Results” to save a JSON file.</p>` },
      { kind:'html', html:`<div class="grid2"><button id="btnExport" class="primary">Export JSON</button><button id="btnReset" class="ghost">Clear Data & Restart</button></div>` }
    ]
  }
];

// ======== Render & State ========
const content = document.getElementById('content');
const titleEl = document.getElementById('title');
const tagEl = document.getElementById('pageTag');
const bar = document.getElementById('bar');
const vidCaption = document.getElementById('vidCaption');
const btnNext = document.getElementById('btnNext');
const btnBack = document.getElementById('btnBack');

let STATE = { page: 0, answers: {} }; // refresh clears answers

function save(){ /* no-op to avoid persistence */ }

function pct(n){ return Math.round((n)/(PAGES.length-1)*100); }

function render(){
  const p = PAGES[STATE.page];
  titleEl.textContent = p.title;
  tagEl.textContent = p.tag || '';
  bar.style.width = Math.round((STATE.page)/(PAGES.length-1)*100) + '%';

  // Media area
  const videoWrapEl = document.querySelector('.videoWrap');

  const isVideoPath = (path) => /\.(mp4|webm|ogg)(\?.*)?$/i.test(path || '');
  const isImagePath = (path) => /\.(png|jpe?g|webp|gif|svg)(\?.*)?$/i.test(path || '');

  const clearMedia = () => {
    if (!videoWrapEl) return;
    videoWrapEl.querySelectorAll('video').forEach(v => { try { v.pause(); } catch(e){} });
    videoWrapEl.innerHTML = '';
  };

  const renderMedia = (media) => {
    if (!videoWrapEl) return;
    videoWrapEl.style.display = 'flex';
    videoWrapEl.style.flexDirection = 'column';
    videoWrapEl.style.alignItems = 'center';
    videoWrapEl.style.justifyContent = 'center';
    videoWrapEl.style.gap = '12px';

    const list = Array.isArray(media) ? media : [media];

    list.forEach(src => {
      if (isVideoPath(src)) {
        const v = document.createElement('video');
        v.setAttribute('controls', 'controls');
        v.setAttribute('preload', 'metadata');
        v.setAttribute('playsinline', '');
        v.setAttribute('webkit-playsinline', '');
        v.setAttribute('x5-playsinline', '');
        v.setAttribute('controlslist', 'nodownload noplaybackrate');
        v.src = src;
        v.style.width = '720px';
        v.style.maxWidth = '100%';
        v.style.display = 'block';
        v.style.background = '#000';
        videoWrapEl.appendChild(v);
      } else if (isImagePath(src)) {
        const im = document.createElement('img');
        im.src = src;
        im.alt = p.title || 'image';
        im.style.width = '720px';
        im.style.maxWidth = '100%';
        im.style.height = 'auto';
        im.style.maxHeight = '100%';
        im.style.objectFit = 'contain';
        im.style.display = 'block';
        im.style.background = '#000';
        videoWrapEl.appendChild(im);
      }
    });

    if (!videoWrapEl.children.length) {
      videoWrapEl.style.display = 'none';
    }
  };

  clearMedia();
  if (p.video) {
    renderMedia(p.video);
    vidCaption.innerHTML = p.caption || '';
  } else {
    if (videoWrapEl) videoWrapEl.style.display = 'none';
    vidCaption.innerHTML = p.caption || 'Proceed after answering on the right.';
  }

  if (p.id === 'consent') {
    // Consent page: show centered text in the media area
    videoWrapEl.style.display = 'flex';
    videoWrapEl.style.flexDirection = 'column';
    videoWrapEl.style.justifyContent = 'center';
    videoWrapEl.style.alignItems = 'center';
    videoWrapEl.innerHTML = `
      <div style="text-align:center; padding:20px; font-size:18px; line-height:1.6; color:var(--ink);">
        ${p.caption}
      </div>
    `;
    document.querySelector('.caption').style.display = 'none';
  } else {
    document.querySelector('.caption').style.display = '';
  }

  // Right side
  content.innerHTML = '';
  if (p.type === 'intro' || p.type === 'finish') {
    (p.blocks || []).forEach(b => {
      if (b.kind === 'html') {
        const d = document.createElement('div');
        d.innerHTML = b.html;
        content.appendChild(d);
      } else if (b.kind === 'checkbox') {
        content.appendChild(renderCheckbox(b));
      } else if (b.kind === 'text') {
        content.appendChild(renderText(b));
      }
    });
  } else if (p.type === 'video+qs' || p.type === 'questions') {
    (p.questions || []).forEach(q => content.appendChild(renderQuestion(q)));
  }

  // Footer buttons
  btnBack.style.visibility = STATE.page === 0 ? 'hidden' : 'visible';
  if (p.type === 'finish') {
    btnNext.style.display = 'none';
  } else {
    btnNext.style.display = 'inline-block';
    btnNext.textContent = STATE.page === PAGES.length - 1 ? 'Finish' : 'Next';
  }

  fitMediaHeights(videoWrapEl);
  updateConditionalVisibility(p);

  // Scroll to top after render
  content.scrollTop = 0;
  requestAnimationFrame(() => {
    window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
  });
}

function isVisibleQuestion(q){
  if(!q) return true;
  if(q.dependsOn == null) return true;
  const v = STATE.answers[q.dependsOn];
  if(q.hasOwnProperty('equals')) return v === q.equals;
  if(Array.isArray(q.oneOf)) return q.oneOf.includes(v);
  return true;
}

function updateConditionalVisibility(p){
  const all = [];
  (function collect(qs){
    (qs||[]).forEach(q=>{
      all.push(q); // include group itself
      if(q.type==='group') collect(q.items||[]);
    });
  })(p.questions);

  all.forEach(q=>{
    const el = content.querySelector(`[data-qid="${q.id}"]`);
    if(!el) return;
    const visible = isVisibleQuestion(q);
    el.style.display = visible ? '' : 'none';
  });
}

function fitMediaHeights(wrap){
  if(!wrap) return;
  const items = Array.from(wrap.children).filter(el =>
    el.tagName === 'IMG' || el.tagName === 'VIDEO'
  );
  const n = items.length;
  if(n === 0) return;

  const GAP = 12;
  const wrapStyles = getComputedStyle(wrap);
  const py = parseFloat(wrapStyles.paddingTop) + parseFloat(wrapStyles.paddingBottom);
  const wrapH = wrap.clientHeight - py;
  const maxH = Math.floor((wrapH - GAP*(n-1)) / n);

  items.forEach(el => {
    el.style.maxHeight = maxH > 0 ? `${maxH}px` : '';
    el.style.width = 'min(720px, 100%)';
    el.style.maxWidth = '100%';
    el.style.objectFit = 'contain';
  });
}

function renderQuestion(q){
  if(q.type==='group'){
    const wrap=document.createElement('div');
    wrap.className='q';
    wrap.dataset.qid = q.id;
    const h=document.createElement('h4'); h.textContent=q.label; wrap.appendChild(h);
    (q.items||[]).forEach(item=> wrap.appendChild(renderQuestion(item)));
    return wrap;
  }
  if(q.type==='html_info'){
    const wrap=document.createElement('div'); wrap.className='q'; wrap.dataset.qid=q.id;
    const d=document.createElement('div'); d.innerHTML='<em>Use Next to continue.</em>';
    wrap.appendChild(d); return wrap;
  }

  const node=document.createElement('div'); node.className='q';
  node.dataset.qid = q.id;
  const h=document.createElement('h4'); h.textContent=q.label; node.appendChild(h);
  const ans = STATE.answers[q.id];

  if(q.type==='likert7'){
    node.appendChild(renderLikert(q.id, ans));
    node.appendChild(hint('1 = Strongly disagree … 7 = Strongly agree'));
  } else if(q.type==='yesno'){
    node.appendChild(renderOpts(q.id,[{v:'yes',t:'Yes'},{v:'no',t:'No'}], ans));
  } else if(q.type==='opts'){
    const items = (q.options||[]).map(it=>({v:it.v, t:it.t}));
    node.appendChild(renderOpts(q.id, items, ans));
  } else if(q.type==='checkbox'){
    node.appendChild(renderChecks(q.id, q.options||[], ans));
  } else if(q.type==='text'){
    node.appendChild(renderText({id:q.id, placeholder:q.placeholder||'', value:ans||''}));
  } else if(q.type==='textarea'){
    const ta=document.createElement('textarea'); ta.rows=4; ta.placeholder=q.placeholder||'\n'; ta.value=ans||'';
    ta.oninput=()=>{ STATE.answers[q.id]=ta.value; save(); updateConditionalVisibility(PAGES[STATE.page]); };
    node.appendChild(ta);
  }
  return node;
}

function renderLikert(id, value){
  const box=document.createElement('div'); box.className='likert';
  for(let i=1;i<=7;i++){
    const lab=document.createElement('label');
    const inp=document.createElement('input'); inp.type='radio'; inp.name=id; inp.value=String(i);
    if(String(value)===String(i)) inp.checked=true;
    inp.onchange=()=>{ STATE.answers[id]=i; save(); updateConditionalVisibility(PAGES[STATE.page]); };
    const small=document.createElement('small'); small.className='hint';
    small.textContent = i===1?'1':(i===4?'4':(i===7?'7':''));
    lab.appendChild(inp); lab.appendChild(small); box.appendChild(lab);
  }
  return box;
}
function renderOpts(id, items, value){
  const box=document.createElement('div'); box.className='opts';
  items.forEach(it=>{
    const lab=document.createElement('label');
    const inp=document.createElement('input'); inp.type='radio'; inp.name=id; inp.value=it.v;
    if(value===it.v) inp.checked=true;
    inp.onchange=()=>{ STATE.answers[id]=it.v; save(); updateConditionalVisibility(PAGES[STATE.page]); };
    lab.appendChild(inp); lab.appendChild(document.createTextNode(it.t)); box.appendChild(lab);
  });
  return box;
}
function renderChecks(id, items, value){
  const set=new Set(Array.isArray(value)?value:[]);
  const box=document.createElement('div'); box.className='opts';
  items.forEach(it=>{
    const lab=document.createElement('label');
    const inp=document.createElement('input'); inp.type='checkbox'; inp.value=it.value;
    if(set.has(it.value)) inp.checked=true;
    inp.onchange=()=>{
      if(!STATE.answers[id]) STATE.answers[id]=[];
      const arr=new Set(STATE.answers[id]); inp.checked?arr.add(it.value):arr.delete(it.value);
      STATE.answers[id]=Array.from(arr); save(); updateConditionalVisibility(PAGES[STATE.page]);
    };
    lab.appendChild(inp); lab.appendChild(document.createTextNode(it.label)); box.appendChild(lab);
  });
  return box;
}
function renderText(cfg){
  const wrap=document.createElement('div'); wrap.className='q';
  wrap.dataset.qid = cfg.id;
  const inp=document.createElement('input'); inp.type='text'; inp.placeholder=cfg.placeholder||''; inp.value=STATE.answers[cfg.id]||'';
  inp.oninput=()=>{ STATE.answers[cfg.id]=inp.value; save(); updateConditionalVisibility(PAGES[STATE.page]); };
  wrap.appendChild(inp); return wrap;
}

function renderCheckbox(cfg){
  const wrap=document.createElement('div'); wrap.className='q';
  wrap.dataset.qid = cfg.id;
  const lab=document.createElement('label'); lab.style.display='flex'; lab.style.alignItems='center'; lab.style.gap='10px';
  const inp=document.createElement('input'); inp.type='checkbox';
  const current=STATE.answers[cfg.id];
  const isChecked=Array.isArray(current) ? current.includes('yes') : current===true;
  inp.checked = !!isChecked;
  inp.onchange=()=>{ STATE.answers[cfg.id] = inp.checked ? ['yes'] : []; save(); updateConditionalVisibility(PAGES[STATE.page]); };
  const text=document.createTextNode(cfg.label || (cfg.options?.[0]?.label || 'I agree'));
  lab.appendChild(inp); lab.appendChild(text);
  wrap.appendChild(lab);
  return wrap;
}
function hint(t){ const s=document.createElement('div'); s.className='hint'; s.textContent=t; return s; }

function validate(){
  const p = PAGES[STATE.page];
  const requiredIds = [];

  if(p.type==='video+qs' || p.type==='questions'){
    (p.questions||[]).forEach(q=>{
      if(q.type==='group'){
        if(!isVisibleQuestion(q)) return;   // skip entire group if hidden
        (q.items||[]).forEach(it=>{
          if(it.required && isVisibleQuestion(it)) requiredIds.push(it.id);
        });
      } else {
        if(q.required && isVisibleQuestion(q)) requiredIds.push(q.id);
      }
    });
  } else if(p.type==='intro'){
    (p.blocks||[]).forEach(b=>{ if(b.required && b.id) requiredIds.push(b.id); });
  }

  for(const id of requiredIds){
    const v = STATE.answers[id];
    if(v==null) return false;
    if(Array.isArray(v)){ if(v.length===0) return false; }
    else if(v==='') return false;
  }
  return true;
}

// Navigation (Next / Back)
btnNext.addEventListener('click',()=>{
  if(STATE.page < PAGES.length-1){
    if(!validate()) { alert('Please complete the required questions on this page first.'); return; }

    const current = PAGES[STATE.page];

    if(current.id === 'pre_gate'){
      const ans = STATE.answers['done_interview_before']; // 'yes' or 'no'
      const idxOverview = PAGES.findIndex(p=>p.id==='overview');
      const idxBackground = PAGES.findIndex(p=>p.id==='pre_background');
      if(ans === 'yes'){
        STATE.page = (idxOverview>=0 ? idxOverview : STATE.page+1);
      } else {
        STATE.page = (idxBackground>=0 ? idxBackground : STATE.page+1);
      }
      save(); render(); return;
    }

    if(current.id === 'pre_background'){
      const idxOverview = PAGES.findIndex(p=>p.id==='overview');
      STATE.page = (idxOverview>=0 ? idxOverview : STATE.page+1);
      save(); render(); return;
    }

    STATE.page++; save(); render();
  }
});

function shouldSkipPage(page){
  if(!page) return false;
  if (page.id === 'pre_background' && STATE.answers['done_interview_before'] === 'yes') {
    return true;
  }
  return false;
}

btnBack.addEventListener('click', ()=>{
  if (STATE.page > 0) {
    let prev = STATE.page - 1;
    while (prev >= 0 && shouldSkipPage(PAGES[prev])) { prev--; }
    STATE.page = Math.max(0, prev);
    save(); render();
  }
});

// Export & Reset
content.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='btnExport'){
    const blob = new Blob([JSON.stringify(STATE,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=(STATE.answers.pid||'eval')+'.json'; a.click(); URL.revokeObjectURL(url);
  }
  if(e.target && e.target.id==='btnReset'){
    if(confirm('Clear local data and restart from the first page?')){
      STATE={page:0,answers:{}}; render();
    }
  }
});

// Make conditional UI react instantly
content.addEventListener('input', ()=>{ updateConditionalVisibility(PAGES[STATE.page]); });
content.addEventListener('change', ()=>{ updateConditionalVisibility(PAGES[STATE.page]); });

// Initial render
render();
</script>
</body>
</html>
