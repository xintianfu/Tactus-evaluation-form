<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Music Score Practice System — Evaluation Questionnaire (1:1 Interview)</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#171923;--ink:#e6e8ef;--muted:#aab0c0;--brand:#714800;--ok:#2ecc71;--warn:#f39c12
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .app{display:grid;grid-template-columns:1.2fr 1fr;gap:16px;height:100vh;padding:16px;box-sizing:border-box}
    @media (max-width: 1000px){.app{grid-template-columns:1fr;grid-auto-rows:min-content}}
    .left,.right{background:var(--panel);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.3);overflow:hidden;position:relative}
    .left{display:flex;flex-direction:column}
    .videoWrap{position:relative;aspect-ratio:16/9;background:#0b0d12;display:grid;place-items:center}
    video{width:100%;height:100%;object-fit:contain;background:#000}
    .caption{padding:12px 16px;color:var(--muted);border-top:1px solid rgba(255,255,255,.05)}
    .right{display:flex;flex-direction:column}
    .head{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.05)}
    .title{font-weight:700}
    .progress{height:6px;background:#222532;border-radius:999px;margin:0 16px 10px;overflow:hidden}
    .bar{height:100%;background:var(--brand);width:0}
    .content{padding:12px 16px 8px;overflow:auto}
    .q{margin:12px 0;padding:12px 12px 8px;border:1px solid rgba(255,255,255,.06);border-radius:10px}
    .q h4{margin:0 0 8px;font-size:16px}
    .likert{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:8px}
    .likert label{display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px;border-radius:8px;background:#1b1e29;cursor:pointer;border:1px solid transparent}
    .likert input{accent-color:var(--brand)}
    .hint{color:var(--muted);font-size:12px}
    .opts{display:grid;gap:8px;margin-top:6px}
    .opts label{display:flex;align-items:center;gap:10px;background:#1b1e29;padding:8px;border-radius:8px}
    textarea, input[type="text"]{width:100%;box-sizing:border-box;background:#121420;border:1px solid #2a2f40;color:var(--ink);border-radius:10px;padding:10px}
    .footer{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid rgba(255,255,255,.05)}
    button{background:#222532;color:var(--ink);border:1px solid rgba(255,255,255,.08);padding:10px 14px;border-radius:10px;cursor:pointer}
    .primary{background:var(--brand);border-color:transparent}
    .ghost{background:transparent}
    .pill{display:inline-block;padding:2px 8px;border:1px solid rgba(255,255,255,.12);border-radius:999px;color:var(--muted);font-size:12px}
    .meta{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:13px}
    .notice{padding:10px 12px;background:#131624;border-left:4px solid var(--brand);border-radius:8px;color:#d9dbe6}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){.grid2{grid-template-columns:1fr}}
    .videoWrap {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      overflow: hidden;
    }
    .videoWrap video{
      width: 720px;
      height: auto;
      max-height: 100%;
      object-fit: contain;
    }
    .videoWrap img{
      width: 720px;
      height: auto;
      max-height: 100%;
      object-fit: contain;
      display: block;
      background: #FCF7F4 !important;
      border-radius: 0;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Left: media area -->
  <section class="left">
    <div class="videoWrap">
      <video id="vid" controls preload="metadata" poster="" src=""
       playsinline webkit-playsinline x5-playsinline
       controlslist="nodownload noplaybackrate">
        Your browser does not support the video tag.
      </video>
      <!-- Image placeholder -->
      <img id="pic" alt="" style="display:none;" />
    </div>
    <div class="caption">
      <div class="meta">
        <span class="pill" id="pageTag">Overview</span>
        <span id="vidCaption">Please watch the introduction video first, then answer the questions on the right.</span>
      </div>
    </div>
  </section>

  <!-- Right: questionnaire area -->
  <section class="right">
    <div class="head">
      <div class="title" id="title">Music Score Practice System — Evaluation Questionnaire (Interview)</div>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <div class="content" id="content"></div>
    <div class="footer">
      <button class="ghost" id="btnBack">Back</button>
      <button class="primary" id="btnNext">Next</button>
    </div>
  </section>
</div>

<script>
// ======== Pages & Questions ========
const PAGES = [
  {
    id: 'consent', type: 'intro',
    title: 'Before We Start', tag: 'Consent',
    caption: 'Thank you for taking part in this study, in which we want to gather feedback on a research tool/system prototype. This study is part of a contribution in a research article. We will be recording your written and spoken responses to help inform our analysis. You can stop this study at any moment and ask for your data to be deleted. Otherwise, we will delete your data upon publication of our article.',
    blocks: [
      { kind:'html', html:`<div class="notice">Flow: Overview video → Feature-by-feature demonstration → Comprehension of visualizations. All questions on the right are required (except open-ended ones).</div>`},
      { kind:'checkbox', id:'consent', label:'I have read the study information and agree to participate in this research.', options:[{value:'yes',label:'Agree'}], required:true },
      { kind:'text', id:'pid', label:'Participant ID (filled by the researcher; may be left blank)', placeholder:'e.g., P07', required:true }
    ]
  },

  {
    id: 'pre_gate',
    type: 'questions',
    tag: 'Pre-Check',
    title: 'Before the overview',
    caption: 'Have you previously taken part in an interview for this study?',
    questions: [
      { id: 'done_interview_before', label: 'Have you done an interview before for this study?', type: 'yesno', required: true }
    ]
  },

  {
    id: 'pre_background',
    type: 'questions',
    tag: 'Background',
    title: 'Your background with music practice',
    caption: 'Please answer a few questions about your musical background.',
    questions: [
      { id: 'main_instrument', label: 'What main instrument do you play?', type: 'text', required: true },
      { id: 'learning_duration', label: 'How long have you been learning this instrument?', type: 'text', required: true },
      {
        id: 'learned_mode',
        label: 'Did you learn by yourself, or do you/did you have a teacher?',
        type: 'opts',
        required: true,
        options: [
          { v:'self',    t:'I learned by myself' },
          { v:'teacher', t:'I have/had a teacher' },
          { v:'both',    t:'Both' }      
        ]
      },
      {
        id: 'ensemble_mode',
        label: 'Do you play alone, or do you also play with other musicians?',
        type: 'opts',
        required: true,
        options: [
          { v:'alone', t:'I usually play alone' },
          { v:'others', t:'I usually play with other musicians' },
          { v:'both',  t:'Both' }  
        ]
      },
      {
        id: 'ensemble_marking_diff',
        label: 'If other musicians: Have you noticed any differences in how you mark your sheet music when playing solo, in a duet, or in an orchestra?',
        type: 'textarea',
        placeholder: 'Describe any differences you’ve noticed…',
        required: true,
        dependsOn: 'ensemble_mode',
        oneOf: ['others','both']
      },

      { id: 'marking_routine',
        label: 'Do you have your own “marking routine”? (e.g., annotate after each page, or whenever something comes to mind)',
        type: 'textarea',
        placeholder: 'Describe your routine if any…',
        required: true
      },

      { id: 'practice_medium', label: 'Do you usually use printed scores or a tablet to practice?', type: 'group', items: [
          { id: 'practice_medium_choice', label: 'Choose one', type: 'opts', required: true,
            options: [
              { v:'printed', t:'Printed scores' },
              { v:'tablet',  t:'Tablet' },
              { v:'both',    t:'Both' }
            ]
          },
          { id: 'practice_why', label: 'Why?', type: 'textarea', placeholder: 'Your reasons…', required: true }
      ]},
      {
        id: 'tablet_software_block',
        label: 'If you use a tablet:',
        type: 'group',
        dependsOn: 'practice_medium_choice',   
        oneOf: ['tablet','both'],             
        items: [
          {
            id: 'tablet_software',
            label: 'What software do you use?',
            type: 'text',
            required: true
          },
          {
            id: 'tablet_duration',
            label: 'For how long have you used it?',
            type: 'text',
            required: true
          },
          {
            id: 'tablet_features_helpful',
            label: 'What are some helpful features you’ve experienced with it?',
            type: 'textarea',
            placeholder: 'List helpful features…',
            required: true
          },
          {
            id: 'tablet_features_inconveniences',
            label: 'What inconveniences have you experienced with it?',
            type: 'textarea',
            placeholder: 'List inconveniences…',
            required: true
          }
        ]
      },

      {
        id: 'piece_learning_time',
        label: 'How long did it take you to learn this piece?',
        type: 'text',
        required: true
      }
    ]
  },

  // A. Overview
  {
    id:'overview', type:'video+qs', tag:'Overview',
    title:'Overview: System Goals & Gesture Triggers',
    video:'1.mp4',
    caption:'Shows system goals, five core functions, and corresponding gestures: clef / sharp / circle / two vertical lines / circle + vertical line (perform).',
    questions:[
      { id:'useful_system', label:'Do you think this system would be useful for you?', type:'likert7', required:true },
      { id:'intend_use', label:'Would you be willing to use it in your daily practice?', type:'likert7', required:true },
      { id:'useful_functions', label:'Please rate the usefulness of the five core features (1 = Not useful at all, 7 = Very useful).', type:'group', items:[
          { id:'func_clef',   label:'(1) Reveal all accidentals', type:'likert7', required:true },
          { id:'func_annot',  label:'(2) Add annotation', type:'likert7', required:true },
          { id:'func_pitch',  label:'(3) Pitch practice (singing the melody to train pitch)', type:'likert7', required:true },
          { id:'func_rhythm', label:'(4) Rhythm practice (tapping with a metronome and the score)', type:'likert7', required:true },
          { id:'func_perform',label:'(5) Performance practice (record audio to train pitch + rhythm together)', type:'likert7', required:true }
      ]},
      { id:'train_mode1', label:'Do you feel that selecting a specific segment to hide the rest of the score would help you focus during practice?', type:'likert7', required:true },
      { id:'train_mode2', label:'Do you feel that visual feedback would help you practice?', type:'likert7', required:true }
    ]
  },

  // B. Gestures
  {
    id:'gestures1', type:'video+qs', tag:'Gestures-1',
    title:'I. Gesture Comprehension (Part 1)',
    video:'1.mp4',
    caption:'Demonstrates the triggers and corresponding functions for clef / sharp / circle / two vertical lines / circle + two vertical lines.',
    questions:[
      { id:'g_clef_easy', label:'Please evaluate the gesture that triggers the display of accidentals (clef).', type:'group', items:[
          { id:'g_clef_easy1',   label:'Do you find this easy to perform?', type:'likert7', required:true },
          { id:'g_clef_easy2',  label:'Do you find this easy to remember?', type:'likert7', required:true },
      ]},
      { id:'g_sharp_easy', label:'Please evaluate the gesture that triggers annotation (sharp).', type:'group', items:[
          { id:'g_sharp_easy1',   label:'Do you find this easy to perform?', type:'likert7', required:true },
          { id:'g_sharp_easy2',  label:'Do you find this easy to remember?', type:'likert7', required:true },
      ]},
      { id:'g_circle_easy', label:'Please evaluate the gesture that triggers pitch practice (circle).', type:'group', items:[
          { id:'g_circle_easy1',   label:'Do you find this easy to perform?', type:'likert7', required:true },
          { id:'g_circle_easy2',  label:'Do you find this easy to remember?', type:'likert7', required:true },
      ]},
      { id:'g_vlines_easy', label:'Please evaluate the gesture that triggers rhythm practice (two vertical lines).', type:'group', items:[
          { id:'g_vlines_easy1',   label:'Do you find this easy to perform?', type:'likert7', required:true },
          { id:'g_vlines_easy2',  label:'Do you find this easy to remember?', type:'likert7', required:true },
      ]},
      { id:'g_play_easy', label:'Please evaluate the gesture that triggers performance mode (circle + two vertical lines).', type:'group', items:[
          { id:'g_play_easy1',   label:'Do you find this easy to perform?', type:'likert7', required:true },
          { id:'g_play_easy2',  label:'Do you find this easy to remember?', type:'likert7', required:true },
      ]}
    ]
  },
  {
    id:'gestures2', type:'video+qs', tag:'Gestures-2',
    title:'I. Gesture Comprehension (Part 2)',
    video:'1.mp4',
    caption:'In performance mode, circle / vertical lines are used to expand detailed pitch/rhythm visualizations.',
    questions:[
      { id:'g_perf_circle_pitch', label:'Please evaluate the gesture that expands detailed pitch visualization in performance mode (circle).', type:'group', items:[
          { id:'g_perf_circle_pitch1',   label:'Do you find this easy to perform?', type:'likert7', required:true },
          { id:'g_perf_circle_pitch2',  label:'Do you find this easy to remember?', type:'likert7', required:true },
      ]},
      { id:'g_perf_vlines_rhy', label:'Please evaluate the gesture that expands detailed rhythm visualization in performance mode (two vertical lines).', type:'group', items:[
          { id:'g_perf_vlines_rhy1',   label:'Do you find this easy to perform?', type:'likert7', required:true },
          { id:'g_perf_vlines_rhy2',  label:'Do you find this easy to remember?', type:'likert7', required:true },
      ]}
    ]
  },

  // C1. Pitch visualization
  {
    id:'viz_pitch', type:'video+qs', tag:'Viz-Pitch',
    title:'II. Visualization: Pitch Errors',
    video:'2pitch.mp4',
    caption:'Shows two types of pitch errors roughly(too high / too low), and the use of colors and symbols.',
    questions:[
      { id:'vp_is_pitch',        label:'Do these marks clearly indicate “pitch”?', type:'likert7', required:true },
      { id:'vp_where_wrong',     label:'Can you locate where the error occurs?', type:'likert7', required:true },
      { id:'vp_kind',            label:'Can you distinguish “too high / too low” and roughly the magnitude of the error?', type:'likert7', required:true },
      { id:'vp_readable',        label:'Is it readable / easy to see overall?', type:'likert7', required:true },
      { id:'vp_open',            label:'Additional comments (Pitch visualization)', type:'textarea', placeholder:'Any pros/cons or suggestions you noticed', required:false }
    ]
  },

  // C2. Rhythm visualization
  {
    id:'viz_rhythm1', type:'video+qs', tag:'Viz-Rhythm',
    title:'II. Visualization: Rhythm Errors (1)',
    video:'3rhythm.mp4',
    caption:'Shows two types of rhythm errors (too fast / too slow) as well as colors and symbols.',
    questions:[
      { id:'vr_is_rhy',     label:'Do these marks clearly indicate “rhythm”?', type:'likert7', required:true },
      { id:'vr_where_wrong',label:'Can you locate where the error occurs?', type:'likert7', required:true },
      { id:'vr_kind',       label:'Can you distinguish “too fast / too slow” and roughly the amount of deviation?', type:'likert7', required:true },
      { id:'vr_readable',   label:'Is it readable / easy to see overall?', type:'likert7', required:true }
    ]
  },
  {
    id:'viz_rhythm2', type:'video+qs', tag:'Viz-Rhythm',
    title:'II. Visualization: Rhythm Errors (2)',
    video:'2.png',
    caption:'Shows another rhythm errors viz with different logic.',
    questions:[
      { id:'vr_is_rhy2',     label:'Do these marks clearly indicate “rhythm”?', type:'likert7', required:true },
      { id:'vr_where_wrong2',label:'Can you locate where the error occurs?', type:'likert7', required:true },
      { id:'vr_kind2',       label:'Can you distinguish “too fast / too slow” and roughly the amount of deviation?', type:'likert7', required:true },
      { id:'vr_readable2',   label:'Is it readable / easy to see overall?', type:'likert7', required:true }
    ]
  },
  {
    id:'viz_rhythm3', type:'video+qs', tag:'Viz-Rhythm',
    title:'II. Visualization: Comparing Rhythm Error Visualizations',
    video:['1.png','2.png'],
    caption:'Compare two rhythm error visualizations',
    questions:[
      { id:'vr_is_rhy3', label:'Between these two rhythm visualizations, which one is easier to understand?', type:'likert7', required:true },
      { id:'vr_open3',   label:'Additional comments (Rhythm visualization)', type:'textarea', placeholder:'Any pros/cons or suggestions you noticed', required:false }
    ]
  },

  // C3. Combined visualization (performance mode)
  {
    id:'viz_combo_rough', type:'video+qs', tag:'Viz-Combined',
    title:'II. Visualization: Combined (Pitch + Rhythm)',
    video:'4combine1.mp4',
    caption:'Performance mode: pitch and rhythm errors appear together.',
    questions:[
      { id:'combine_pitch_rough', label:'Please rate the pitch visualization', type:'group', items:[
          { id:'vc_pitch_localize', label:'Can you understand where the pitch went wrong?', type:'likert7', required:true },
          { id:'vc_pitch_kind',     label:'Can you tell “too high / too low” and roughly how far off?', type:'likert7', required:true },
          { id:'vc_pitch_readable', label:'Are the icons/images for pitch readable / clear?', type:'likert7', required:true }
      ]},
      { id:'combine_rhythm_rough', label:'Please rate the rhythm visualization', type:'group', items:[
          { id:'vc_rhythm_localize', label:'Can you understand where the rhythm went wrong?', type:'likert7', required:true },
          { id:'vc_rhythm_kind',     label:'Can you tell “too fast / too slow” and roughly how far off?', type:'likert7', required:true },
          { id:'vc_rhythm_readable', label:'Are the icons/images for rhythm readable / clear?', type:'likert7', required:true }
      ]},
      { id:'combine_pitch_rhythm_rough', label:'Please rate the combined visualization (pitch + rhythm)', type:'group', items:[
          { id:'vc_pr',            label:'Can you understand the meaning of the triangle that appears here?', type:'likert7', required:true },
          { id:'vc_p_localize',    label:'Can you understand where the pitch went wrong?', type:'likert7', required:true },
          { id:'vc_p_kind',        label:'Can you tell “too high / too low” and roughly how far off?', type:'likert7', required:true },
          { id:'vc_p_readable',    label:'Are pitch icons/images readable / clear?', type:'likert7', required:true },
          { id:'vc_r_localize',    label:'Can you understand where the rhythm went wrong?', type:'likert7', required:true },
          { id:'vc_r_kind',        label:'Can you tell “too fast / too slow” and roughly how far off?', type:'likert7', required:true },
          { id:'vc_r_readable',    label:'Are rhythm icons/images readable / clear?', type:'likert7', required:true }
      ]}
    ]
  },
  {
    id:'viz_combo_p', type:'video+qs', tag:'Viz-Combined',
    title:'II. Visualization: Combined — Detailed Pitch Errors',
    video:'4combine2.mp4',
    caption:'circle shows detailed pitch and vertical lines show detailed rhythm. Includes click-triggered animations/images.',
    questions:[
      { id:'vc_pitch_localize2', label:'Now can you understand exactly where the pitch went wrong?', type:'likert7', required:true },
      { id:'vc_pitch_kind2',     label:'Can you tell “too high / too low” and the specific amount of deviation?', type:'likert7', required:true },
      { id:'vc_pitch_readable2', label:'Are the detailed pitch icons/images readable / clear?', type:'likert7', required:true },
      { id:'vc_rhy_localize2',   label:'At this time, rhythm error visualization is at the top of the rectangle. Can you understand where rhythm errors occur?', type:'likert7', required:true },
      { id:'vc_rhy_kind2',       label:'Can you tell “too fast / too slow” and roughly how far off?', type:'likert7', required:true },
      { id:'vc_rhy_readable2',   label:'Is the top rhythm visualization readable / clear?', type:'likert7', required:true },
      { id:'vc_anim_pitch',     label:'Does the “note head movement” animation after clicking clearly express pitch errors?', type:'likert7', required:true },
      { id:'vc_anim_meter',     label:'Does the “fine pitch deviation graphic” after clicking the gauge icon clearly express the error?', type:'likert7', required:true }
    ]
  },
  {
    id:'viz_combo_r', type:'video+qs', tag:'Viz-Combined',
    title:'II. Visualization: Combined — Detailed Rhythm Errors',
    video:'4combine3.mp4',
    caption:'circle shows detailed pitch and vertical lines show detailed rhythm. Includes click-triggered animations/images.',
    questions:[
      { id:'vc_pitch_localize3', label:'Now can you understand exactly where the rhythm went wrong?', type:'likert7', required:true },
      { id:'vc_pitch_kind3',     label:'Can you tell “too fast / too slow” and the specific amount of deviation?', type:'likert7', required:true },
      { id:'vc_pitch_readable3', label:'Are the slanted rhythm lines readable / clear?', type:'likert7', required:true },
      { id:'vc_rhy_localize3',   label:'At this time, pitch error visualization is at the top of the rectangle. Can you understand where pitch errors occur?', type:'likert7', required:true },
      { id:'vc_rhy_kind3',       label:'Can you tell “too high / too low” and roughly how far off?', type:'likert7', required:true },
      { id:'vc_rhy_readable3',   label:'Is the top pitch visualization readable / clear?', type:'likert7', required:true },
      { id:'vc_anim_rhy',       label:'After clicking the slanted line, does the “line rotation + horizontal note-head movement” animation clearly express rhythm errors?', type:'likert7', required:true },
      { id:'vc_sep_or_together',label:'Focusing separately on pitch and rhythm vs. both together: do you prefer handling them separately? (1 = Strongly disagree, 7 = Strongly agree)', type:'likert7', required:true },
      { id:'vc_open',           label:'Additional comments (Combined visualization / interaction)', type:'textarea', placeholder:'Any thoughts on the combined visuals or interactions', required:false }
    ]
  },

  // Finish
  {
    id:'finish', type:'finish', tag:'Finish', title:'Finish & Export',
    blocks:[
      { kind:'html', html:`<p>Thank you for your participation! Click “Export Results” to save a JSON file.</p>` },
      { kind:'html', html:`<div class="grid2"><button id="btnExport" class="primary">Export JSON</button><button id="btnReset" class="ghost">Clear Data & Restart</button></div>` }
    ]
  }
];

// ======== Render & State ========
const content = document.getElementById('content');
const titleEl = document.getElementById('title');
const tagEl = document.getElementById('pageTag');
const bar = document.getElementById('bar');
const vid = document.getElementById('vid');
const vidCaption = document.getElementById('vidCaption');
const btnNext = document.getElementById('btnNext');
const btnBack = document.getElementById('btnBack');


let STATE = { page: 0, answers: {} };
if(!STATE.page){ STATE.page = 0; STATE.answers = {}; }

function save(){  }

function pct(n){ return Math.round((n)/(PAGES.length-1)*100); }

function render(){
  // Header & progress
  const p = PAGES[STATE.page];
  titleEl.textContent = p.title;
  tagEl.textContent = p.tag || '';
  bar.style.width = Math.round((STATE.page)/(PAGES.length-1)*100) + '%';

  // Media area
  const videoWrapEl = document.querySelector('.videoWrap');
  const vidCaptionEl = vidCaption;

  const isVideoPath = (path) => /\.(mp4|webm|ogg)(\?.*)?$/i.test(path || '');
  const isImagePath = (path) => /\.(png|jpe?g|webp|gif|svg)(\?.*)?$/i.test(path || '');

  const clearMedia = () => {
    if (!videoWrapEl) return;
    videoWrapEl.querySelectorAll('video').forEach(v => { try { v.pause(); } catch(e){} });
    videoWrapEl.innerHTML = '';
  };

  const renderMedia = (media) => {
    if (!videoWrapEl) return;
    videoWrapEl.style.display = 'flex';
    videoWrapEl.style.flexDirection = 'column';
    videoWrapEl.style.alignItems = 'center';
    videoWrapEl.style.justifyContent = 'center';
    videoWrapEl.style.gap = '12px';

    const list = Array.isArray(media) ? media : [media];

    list.forEach(src => {
      if (isVideoPath(src)) {
        const v = document.createElement('video');
        v.setAttribute('controls', 'controls');
        v.setAttribute('preload', 'metadata');
        v.setAttribute('playsinline', '');
        v.setAttribute('webkit-playsinline', '');
        v.setAttribute('x5-playsinline', '');
        v.setAttribute('controlslist', 'nodownload noplaybackrate');
        v.src = src;
        v.style.width = '720px';
        v.style.maxWidth = '100%';
        v.style.display = 'block';
        v.style.background = '#000';
        videoWrapEl.appendChild(v);
      } else if (isImagePath(src)) {
        const im = document.createElement('img');
        im.src = src;
        im.alt = p.title || 'image';
        im.style.width = '720px';
        im.style.maxWidth = '100%';
        im.style.height = 'auto';
        im.style.maxHeight = '100%';
        im.style.objectFit = 'contain';
        im.style.display = 'block';
        im.style.background = '#000';
        videoWrapEl.appendChild(im);
      }
    });

    if (!videoWrapEl.children.length) {
      videoWrapEl.style.display = 'none';
    }
  };

  clearMedia();
  if (p.video) {
    renderMedia(p.video);
    vidCaptionEl.textContent = p.caption || '';
  } else {
    if (videoWrapEl) videoWrapEl.style.display = 'none';
    vidCaptionEl.textContent = p.caption || 'Proceed after answering on the right.';
  }

  if (p.id === 'consent') {
    // Consent page: show centered text only
    videoWrapEl.style.display = 'flex';
    videoWrapEl.style.flexDirection = 'column';
    videoWrapEl.style.justifyContent = 'center';
    videoWrapEl.style.alignItems = 'center';
    videoWrapEl.innerHTML = `
      <div style="text-align:center; padding:20px; font-size:18px; line-height:1.6; color:var(--ink);">
        ${p.caption}
      </div>
    `;
    document.querySelector('.caption').style.display = 'none';
  } else {
    document.querySelector('.caption').style.display = '';
  }

  // Right side
  content.innerHTML = '';
  if (p.type === 'intro' || p.type === 'finish') {
    (p.blocks || []).forEach(b => {
      if (b.kind === 'html') {
        const d = document.createElement('div');
        d.innerHTML = b.html;
        content.appendChild(d);
      } else if (b.kind === 'checkbox') {
        content.appendChild(renderCheckbox(b));
      } else if (b.kind === 'text') {
        content.appendChild(renderText(b));
      }
    });
  } else if (p.type === 'video+qs' || p.type === 'questions') {
    (p.questions || []).forEach(q => content.appendChild(renderQuestion(q)));
  }

  // Footer buttons
  btnBack.style.visibility = STATE.page === 0 ? 'hidden' : 'visible';
  if (p.type === 'finish') {
    btnNext.style.display = 'none';   // hide "Next/Finish" on last page
  } else {
    btnNext.style.display = 'inline-block';
    btnNext.textContent = STATE.page === PAGES.length - 1 ? 'Finish' : 'Next';
  }

  fitMediaHeights(videoWrapEl);
  updateConditionalVisibility(p);
  content.scrollTop = 0;

  requestAnimationFrame(() => {
    window.scrollTo({ top: 0, left: 0, behavior: 'auto' }); 
  });

}

function isVisibleQuestion(q){
  if(!q) return true;
  if(q.dependsOn == null) return true;
  const v = STATE.answers[q.dependsOn];
  if(q.hasOwnProperty('equals')) return v === q.equals;
  if(Array.isArray(q.oneOf)) return q.oneOf.includes(v);
  return true;
}

function updateConditionalVisibility(p){
  const all = [];
  const collect = (qs)=> (qs||[]).forEach(q=>{
    all.push(q);   
    if(q.type==='group') collect(q.items||[]);
    else all.push(q);
  });
  collect(p.questions);

  all.forEach(q=>{
    const el = content.querySelector(`[data-qid="${q.id}"]`);
    if(!el) return;
    el.style.display = isVisibleQuestion(q) ? '' : 'none';
  });
}

function fitMediaHeights(wrap){
  if(!wrap) return;
  const items = Array.from(wrap.children).filter(el =>
    el.tagName === 'IMG' || el.tagName === 'VIDEO'
  );
  const n = items.length;
  if(n === 0) return;

  const GAP = 12;
  const wrapStyles = getComputedStyle(wrap);
  const py = parseFloat(wrapStyles.paddingTop) + parseFloat(wrapStyles.paddingBottom);
  const wrapH = wrap.clientHeight - py;
  const maxH = Math.floor((wrapH - GAP*(n-1)) / n);

  items.forEach(el => {
    el.style.maxHeight = maxH > 0 ? `${maxH}px` : '';
    el.style.width = 'min(720px, 100%)';
    el.style.maxWidth = '100%';
    el.style.objectFit = 'contain';
  });
}

function renderQuestion(q){
  if(q.type==='group'){
    const wrap=document.createElement('div'); 
    wrap.className='q';
    wrap.dataset.qid = q.id; 
    const h=document.createElement('h4'); 
    h.textContent=q.label; 
    wrap.appendChild(h);
    (q.items||[]).forEach(item=> wrap.appendChild(renderQuestion(item)));
    return wrap;
  }
  const node=document.createElement('div'); node.className='q';
  node.dataset.qid = q.id; // ★ 用于条件显示定位
  const h=document.createElement('h4'); h.textContent=q.label; node.appendChild(h);
  const ans = STATE.answers[q.id];
  if(q.type==='likert7'){
    node.appendChild(renderLikert(q.id, ans));
    node.appendChild(hint('1 = Strongly disagree … 7 = Strongly agree'));
  } else if(q.type==='yesno'){
    node.appendChild(renderOpts(q.id,[{v:'yes',t:'Yes'},{v:'no',t:'No'}], ans));
  } else if(q.type==='opts'){ // ★ 支持自定义单选选项
    const items = (q.options||[]).map(it=>({v:it.v, t:it.t}));
    node.appendChild(renderOpts(q.id, items, ans));
  } else if(q.type==='checkbox'){
    node.appendChild(renderChecks(q.id, q.options||[], ans));
  } else if(q.type==='text'){
    node.appendChild(renderText({id:q.id, placeholder:q.placeholder||'', value:ans||''}));
  } else if(q.type==='textarea'){
    const ta=document.createElement('textarea'); ta.rows=4; ta.placeholder=q.placeholder||'\n'; ta.value=ans||'';
    ta.oninput=()=>{ STATE.answers[q.id]=ta.value; save(); };
    node.appendChild(ta);
  }
  return node;
}


function renderLikert(id, value){
  const box=document.createElement('div'); box.className='likert';
  for(let i=1;i<=7;i++){
    const lab=document.createElement('label');
    const inp=document.createElement('input'); inp.type='radio'; inp.name=id; inp.value=String(i);
    if(String(value)===String(i)) inp.checked=true;
    inp.onchange=()=>{ STATE.answers[id]=i; save(); };
    const small=document.createElement('small'); small.className='hint';
    small.textContent = i===1?'1':(i===4?'4':(i===7?'7':''));
    lab.appendChild(inp); lab.appendChild(small); box.appendChild(lab);
  }
  return box;
}
function renderOpts(id, items, value){
  const box=document.createElement('div'); box.className='opts';
  items.forEach(it=>{
    const lab=document.createElement('label');
    const inp=document.createElement('input'); inp.type='radio'; inp.name=id; inp.value=it.v;
    if(value===it.v) inp.checked=true; inp.onchange=()=>{ STATE.answers[id]=it.v; save(); };
    lab.appendChild(inp); lab.appendChild(document.createTextNode(it.t)); box.appendChild(lab);
  });
  return box;
}
function renderChecks(id, items, value){
  const set=new Set(Array.isArray(value)?value:[]);
  const box=document.createElement('div'); box.className='opts';
  items.forEach(it=>{
    const lab=document.createElement('label');
    const inp=document.createElement('input'); inp.type='checkbox'; inp.value=it.value;
    if(set.has(it.value)) inp.checked=true; inp.onchange=()=>{
      if(!STATE.answers[id]) STATE.answers[id]=[];
      const arr=new Set(STATE.answers[id]); inp.checked?arr.add(it.value):arr.delete(it.value);
      STATE.answers[id]=Array.from(arr); save();
    };
    lab.appendChild(inp); lab.appendChild(document.createTextNode(it.label)); box.appendChild(lab);
  });
  return box;
}
function renderText(cfg){
  const wrap=document.createElement('div'); wrap.className='q';
  const inp=document.createElement('input'); inp.type='text'; inp.placeholder=cfg.placeholder||''; inp.value=STATE.answers[cfg.id]||'';
  inp.oninput=()=>{ STATE.answers[cfg.id]=inp.value; save(); };
  wrap.appendChild(inp); return wrap;
}

function renderCheckbox(cfg){
  const wrap=document.createElement('div'); wrap.className='q';
  const lab=document.createElement('label'); lab.style.display='flex'; lab.style.alignItems='center'; lab.style.gap='10px';
  const inp=document.createElement('input'); inp.type='checkbox';
  const current=STATE.answers[cfg.id];
  const isChecked=Array.isArray(current) ? current.includes('yes') : current===true;
  inp.checked = !!isChecked;
  inp.onchange=()=>{
    STATE.answers[cfg.id] = inp.checked ? ['yes'] : [];
    save();
  };
  const text=document.createTextNode(cfg.label || (cfg.options?.[0]?.label || 'I agree'));
  lab.appendChild(inp); lab.appendChild(text);
  wrap.appendChild(lab);
  return wrap;
}
function hint(t){ const s=document.createElement('div'); s.className='hint'; s.textContent=t; return s; }

function validate(){
  const p = PAGES[STATE.page];
  const requiredIds = [];

  if(p.type==='video+qs' || p.type==='questions'){
    (p.questions||[]).forEach(q=>{
      if(q.type==='group'){
        if(!isVisibleQuestion(q)) return;   
        (q.items||[]).forEach(it=>{
          if(it.required && isVisibleQuestion(it)) requiredIds.push(it.id);
        });
      } else {
        if(q.required && isVisibleQuestion(q)) requiredIds.push(q.id);
      }
    });
  } else if(p.type==='intro'){
    (p.blocks||[]).forEach(b=>{ if(b.required && b.id) requiredIds.push(b.id); });
  }

  for(const id of requiredIds){
    const v = STATE.answers[id];
    if(v==null) return false;
    if(Array.isArray(v)){ if(v.length===0) return false; }
    else if(v==='') return false;
  }
  return true;
}



btnNext.addEventListener('click',()=>{
  if(STATE.page < PAGES.length-1){
    if(!validate()) { alert('Please complete the required questions on this page first.'); return; }

    const current = PAGES[STATE.page];

    if(current.id === 'pre_gate'){
      const ans = STATE.answers['done_interview_before']; // 'yes' or 'no'

      const idxOverview = PAGES.findIndex(p=>p.id==='overview');
      const idxBackground = PAGES.findIndex(p=>p.id==='pre_background');

      if(ans === 'yes'){
        STATE.page = (idxOverview>=0 ? idxOverview : STATE.page+1);
      } else {
        STATE.page = (idxBackground>=0 ? idxBackground : STATE.page+1);
      }
      save(); render(); return;
    }

    if(current.id === 'pre_background'){
      const idxOverview = PAGES.findIndex(p=>p.id==='overview');
      STATE.page = (idxOverview>=0 ? idxOverview : STATE.page+1);
      save(); render(); return;
    }

    STATE.page++; save(); render();
  }
});
function shouldSkipPage(page){
  if(!page) return false;
  if (page.id === 'pre_background' && STATE.answers['done_interview_before'] === 'yes') {
    return true;
  }
  return false;
}

btnBack.addEventListener('click', ()=>{
  if (STATE.page > 0) {
    let prev = STATE.page - 1;
    while (prev >= 0 && shouldSkipPage(PAGES[prev])) {
      prev--;
    }
    STATE.page = Math.max(0, prev);
    save(); render();
  }
});


content.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='btnExport'){
    const blob = new Blob([JSON.stringify(STATE,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=(STATE.answers.pid||'eval')+'.json'; a.click(); URL.revokeObjectURL(url);
  }
  if(e.target && e.target.id==='btnReset'){
    if(confirm('Clear local data and restart from the first page?')){
      localStorage.removeItem('eval_state_v2'); STATE={page:0,answers:{}}; render();
    }
  }
});
content.addEventListener('input', ()=>{ updateConditionalVisibility(PAGES[STATE.page]); });
content.addEventListener('change', ()=>{ 
  updateConditionalVisibility(PAGES[STATE.page]); 
});



render();
</script>
</body>
</html>
